variant: fcos
version: 1.5.0
passwd:
    users:
      - name: core
        ssh_authorized_keys_local:
          - keys/core.pub
      - name: patroni-user
        ssh_authorized_keys_local:
          - keys/patroni-user.pub
systemd:
    units:
      - name: selinux-permissive.service
        enabled: true
        contents: |
          [Unit]
          Description=Turn SELinux Permissive

          [Service]
          Type=oneshot
          ExecStartPre=/usr/sbin/setenforce 0
          ExecStart=/usr/bin/sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config

          [Install]
          WantedBy=multi-user.target

      - name: enable-linger.service
        enabled: true
        contents: |
          [Unit]
          Description=Enable Linger for patroni-user

          After=selinux-permissive.service
          Requires=selinux-permissive.service

          [Service]
          User=patroni-user
          ExecStart=/usr/bin/loginctl enable-linger patroni-user
          Type=oneshot

          [Install]
          WantedBy=multi-user.target

      - name: patroni.service
        enabled: true
        contents: |
          [Unit]
          Description=Patroni (Spilo) with Podman

          ConditionPathExists=/etc/etcd-network-list
          ConditionFileNotEmpty=/etc/etcd-network-list

          After=selinux-permissive.service
          Requires=selinux-permissive.service

          Requires=enable-linger.service
          After=enable-linger.service

          [Service]
          User=patroni-user
          EnvironmentFile=/etc/etcd-network-list
          Restart=always
          RestartSec=5s
          TimeoutStartSec=0
          LimitNOFILE=40000

          ExecStartPre=/usr/bin/mkdir -p ${HOME}/postgres
          ExecStartPre=/usr/bin/podman rm -f patroni-container
          ExecStart=/usr/bin/podman \
            run \
            --rm \
            --net=host \
            --name patroni-container \
            --env SCOPE=batman \
            --env ETCD3_PROTOCOL="https" \
            --env ETCD3_HOSTS="${ETCD_HOSTS}" \
            ghcr.io/zalando/spilo-15:3.0-p1

          ExecStop=/usr/bin/podman rm -f patroni-container

          [Install]
          WantedBy=multi-user.target
storage:
    files:
        - path: /etc/etcd-network-list
          mode: 0755
          contents:
            local: tmp/etcd-network-list

        - path: /etc/certs/etcd-root-ca.pem
          mode: 0755
          contents:
            local: certs/etcd-root-ca.pem
