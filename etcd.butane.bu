variant: fcos
version: 1.5.0
passwd:
    users:
      - name: core
        ssh_authorized_keys:
          - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCiGUz4OVm53+SzmnHTc4cg3EbzqRhBGJgJIkNyG44p+Jf5HnMw8fTD1rDx13hkq5A3075y2NQu83yz/MFSmxXiZ3qvBJfYVS3rGx+xOPk7Hh21i5mYo25UBbvzveOHFGvR7A7BMH+GcvwCIfBJ9ou3uS4kmxJbyb+aqtU80POeBTtHlV+S7i9VpLrIJ8upFUAfYvHcy7Laz/B4EgNxRtpQkIRv+ISYBiyXs5EtRTQCEMLEYhSUapcT8xJgHKaOun3c6xQe5bqklLHnrkBe23yK/GSgv8Ql1/xkbdQQtZ67ua/sSyYgGYDQwPrd0Xvm0TNA5pwqbXOApITsY2l87P6eV1o+9TVXnF2vqnHN4fn4Gw6+WKPBYWFtSfPRILPADrPyBFf4qzRXyFW+VUzZNtRwev+rcyTtoPT2IwEpZjuOie34sEuoGojPzk4pEvA8Q9ePx5rvKWv9Ip9sXaF6mktGwR3Z76gaBxHf92EzGy3eKV79OyiOfokaPPXnu8PnDhU= core
systemd:
    units:
      - name: selinux-permissive.service
        enabled: true
        contents: |
          [Unit]
          Description=Turn SELinux Permissive

          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/selinux-permissive.sh

          [Install]
          WantedBy=multi-user.target

      - name: create-local-certs.service
        enabled: true
        contents: |
          [Unit]
          Description=Create certs for etcd

          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/create-local-certs.sh

          [Install]
          WantedBy=multi-user.target

      - name: start-etcd.service
        enabled: true
        contents: |
          [Unit]
          Description=Start etcd with Docker
          After=selinux-permissive.service
          Requires=selinux-permissive.service
          Requires=docker.service
          After=docker.service
          Requires=create-local-certs.service
          After=create-local-certs.service

          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/start-etcd.sh

          [Install]
          WantedBy=multi-user.target
storage:
    files:
        - path: /etc/certs/etcd-root-ca.pem
          mode: 0755
          contents:
            local: certs/etcd-root-ca.pem

        - path: /etc/certs/etcd-root-ca-key.pem
          mode: 0755
          contents:
            local: certs/etcd-root-ca-key.pem

        - path: /etc/certs/etcd-gencert.json
          mode: 0755
          contents:
            local: certs/etcd-gencert.json

        - path: /usr/local/bin/selinux-permissive.sh
          mode: 0755
          contents:
            inline: |
              #!/bin/bash
              setenforce 0
              sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config

        - path: /usr/local/bin/create-local-certs.sh
          mode: 0755
          contents:
            inline: |
              #!/bin/bash

              mkdir -p /tmp/certs

              private_ipv4=$(hostname -I | awk '{print $1}')

              # If private_ipv4 is empty, ask again until it is not empty. If already 60 seconds, exit.
              count=0
              while [ -z "$private_ipv4" ]; do
              sleep 1
              private_ipv4=$(hostname -I | awk '{print $1}')
              count=$((count+1))
              if [ $count -eq 60 ]; then
                  echo "Private IPv4 is empty. Check your network."
                  exit 1
              fi
              done

              curl -L https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -o /tmp/cfssl
              chmod +x /tmp/cfssl
              mv /tmp/cfssl /usr/local/bin/cfssl

              curl -L https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -o /tmp/cfssljson
              chmod +x /tmp/cfssljson
              mv /tmp/cfssljson /usr/local/bin/cfssljson

              cat > /tmp/certs/$private_ipv4-ca-csr.json <<EOF
              {
                  "key": {
                      "algo": "rsa",
                      "size": 4096
                  },
                  "names": [
                      {
                      "O": "Proventa",
                      "OU": "AWS Postgres Demo",
                      "L": "Frankfurt",
                      "ST": "Hesse",
                      "C": "Germany"
                      }
                  ],
                  "CN": "$private_ipv4",
                  "hosts": [
                      "127.0.0.1",
                      "localhost",
                      "$private_ipv4"
                  ]
              }
              EOF

              cfssl gencert \
              --ca /etc/certs/etcd-root-ca.pem \
              --ca-key /etc/certs/etcd-root-ca-key.pem \
              --config /etc/certs/etcd-gencert.json \
              /tmp/certs/$private_ipv4-ca-csr.json | cfssljson --bare /tmp/certs/$private_ipv4

              mv /tmp/certs/* /etc/certs

        - path: /usr/local/bin/start-etcd.sh
          mode: 0755
          contents:
            inline: |
              #!/bin/bash

              private_ipv4=$(hostname -I | awk '{print $1}')

              # If private_ipv4 is empty, ask again until it is not empty. If already 60 seconds, exit.
              count=0
              while [ -z "$private_ipv4" ]; do
                sleep 1
                private_ipv4=$(hostname -I | awk '{print $1}')
                count=$((count+1))
                if [ $count -eq 60 ]; then
                  echo "Private IPv4 is empty. Check your network."
                  exit 1
                fi
              done

              mkdir -p /tmp/etcd/data

              # to write service file for etcd with Docker
              cat > /tmp/etcd.service <<EOF
              [Unit]
              Description=etcd with Docker
              Documentation=https://github.com/coreos/etcd

              [Service]
              Restart=always
              RestartSec=5s
              TimeoutStartSec=0
              LimitNOFILE=40000

              ExecStart=/usr/bin/docker \
                run \
                --rm \
                --net=host \
                --name etcd-container \
                --volume=/tmp/etcd/data:/etcd-data \
                --volume=/etc/certs:/etc/ssl/certs \
                gcr.io/etcd-development/etcd:v3.3.8 \
                /usr/local/bin/etcd \
                --name etcd-$private_ipv4 \
                --data-dir /etcd-data \
                --listen-client-urls https://$private_ipv4:2379 \
                --advertise-client-urls https://$private_ipv4:2379 \
                --listen-peer-urls https://$private_ipv4:2380 \
                --initial-advertise-peer-urls https://$private_ipv4:2380 \
                --initial-cluster-token tkn \
                --initial-cluster-state new \
                --client-cert-auth \
                --trusted-ca-file /etc/ssl/certs/etcd-root-ca.pem \
                --cert-file /etc/ssl/certs/$private_ipv4.pem \
                --key-file /etc/ssl/certs/$private_ipv4-key.pem \
                --peer-client-cert-auth \
                --peer-trusted-ca-file /etc/ssl/certs/etcd-root-ca.pem \
                --peer-cert-file /etc/ssl/certs/$private_ipv4.pem \
                --peer-key-file /etc/ssl/certs/$private_ipv4-key.pem \
                --discovery=https://discovery.etcd.io/cf037f8c6bdc9a73be494de1f49d13ff 


              ExecStop=/usr/bin/docker stop etcd-container

              [Install]
              WantedBy=multi-user.target
              EOF

              mv /tmp/etcd.service /etc/systemd/system/etcd.service

              systemctl daemon-reload

              systemctl enable etcd.service

              systemctl start etcd.service